<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil de Usuario</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                  radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      max-width: 800px;
      margin: 0 auto 30px;
    }

    .header h2 {
      color: white;
      font-weight: 700;
      font-size: 28px;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logout-btn, .btn-edit {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin: 5px;
    }

    .logout-btn::before, .btn-edit::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .logout-btn:hover::before, .btn-edit:hover::before {
      left: 100%;
    }

    .logout-btn:hover, .btn-edit:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .perfil-card {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(30px);
      border-radius: 32px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .perfil-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      padding: 50px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .perfil-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: rotate 10s linear infinite;
      opacity: 0.5;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .perfil-header h3 {
      font-size: 36px;
      color: white;
      font-weight: 700;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
      position: relative;
      z-index: 1;
      animation: fadeInUp 0.8s ease-out;
    }

    .editar-container {
      position: relative;
      z-index: 1;
      margin-top: 15px;
    }

    .editar-display {
      color: rgba(255,255,255,0.9);
      font-size: 16px;
      line-height: 1.5;
      font-style: italic;
      max-width: 600px;
      margin: 0 auto;
      word-wrap: break-word;
    }

    .editar-display.vacia {
      opacity: 0.5;
    }

    .editar-form {
      display: none;
      margin-top: 15px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .form-input {
      width: 100%;
      min-height: 48px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      color: white;
      font-family: inherit;
      font-size: 16px;
      padding: 12px 18px;
      margin-bottom: 12px;
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .form-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .form-input:focus {
      outline: none;
      border-color: rgba(100, 181, 246, 0.8);
      box-shadow: 0 0 0 2px rgba(100, 181, 246, 0.2), 0 8px 25px rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }

    select#tipoCuentaSelect option {
      background-color: #1a1a2e; /* Dark background from body gradient */
      color: #FFFFFF;           /* White text */
      /* Padding or other properties might not be consistently applied by browsers */
    }

    select#tipoCuentaSelect option:hover {
        background-color: #3b82f6; /* Example primary blue, for hover, if supported */
        color: #FFFFFF;
    }

/* Styles for the switch container (if needed beyond inline) */
.switch-container {
  /* display: flex; already inline */
  /* align-items: center; already inline */
  /* justify-content: space-between; already inline */
  margin-bottom: 10px; /* Reduced from 15px on the select */
}

/* The switch - a label element */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;  /* Width of the switch track */
  height: 34px; /* Height of the switch track */
  flex-shrink: 0; /* Prevent shrinking if container is too small */
}

/* Hide default HTML checkbox */
.switch input#tipoCuentaSwitch {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider (track and knob) */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255,255,255,0.2); /* Track color when off (Privada) - similar to form input borders */
  border: 1px solid rgba(255,255,255,0.3);
  -webkit-transition: .4s;
  transition: .4s;
  border-radius: 34px; /* Rounded track */
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px; /* Height of the knob */
  width: 26px;  /* Width of the knob */
  left: 4px;    /* Position of the knob when off */
  bottom: 3px;  /* Position of the knob when off (considering border) */
  background-color: white; /* Knob color */
  -webkit-transition: .4s;
  transition: .4s;
  border-radius: 50%; /* Rounded knob */
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

input#tipoCuentaSwitch:checked + .slider {
  background-color: #3b82f6; /* Track color when on (PÃºblica) - primary blue */
  border-color: #60a5fa;
}

input#tipoCuentaSwitch:focus + .slider {
  box-shadow: 0 0 1px #3b82f6, 0 0 0 2px rgba(59, 130, 246, 0.2); /* Focus outline consistent with form-input */
}

input#tipoCuentaSwitch:checked + .slider:before {
  -webkit-transform: translateX(26px); /* Move knob to the right when on */
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Adjustments for the descriptive paragraph below the switch */
#accountPrivacySection > p { /* Targeting the <p> directly under accountPrivacySection */
    font-size: 0.8em; 
    color: rgba(255,255,255,0.7); 
    text-align: center; 
    /* margin-bottom is already inline, but can be centralized here if preferred */
    /* margin-bottom: 15px; */ 
    line-height: 1.4;
}

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    /* Botones actualizados con estilo azul para guardar */
    .btn {
      margin: 6px; 
      padding: 12px 20px; 
      border: none; 
      color: #fff; 
      border-radius: 12px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      font-size: 14px;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover { 
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
    }
    
    .btn-primary:hover { 
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .btn-secondary:hover { 
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .contador-caracteres {
      text-align: center;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin-top: 8px;
      font-weight: 500;
    }

    .contador-caracteres.limite {
      color: rgba(239, 68, 68, 0.8);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .perfil-content {
      padding: 40px 30px;
    }

    .perfil-datos p {
      font-size: 16px;
      margin: 20px 0;
      color: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    .perfil-datos p:hover {
      background: rgba(255,255,255,0.08);
      transform: translateX(5px);
    }

    .contador {
      font-weight: 600;
      font-size: 18px;
      margin: 20px 0;
      color: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .contador span {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    #btnSeguir {
      margin-top: 30px;
      padding: 16px 32px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: white;
      font-weight: 700;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      position: relative;
      overflow: hidden;
    }

    #btnSeguir::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    #btnSeguir:hover::before {
      left: 100%;
    }

    #btnSeguir:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(16, 185, 129, 0.5);
    }

    #btnSeguir.dejar {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    #btnSeguir.dejar:hover {
      box-shadow: 0 15px 30px rgba(239, 68, 68, 0.5);
    }

    .edit-buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }

    @media (max-width: 600px) {
      .perfil-card { margin: 20px; }
      .perfil-header { padding: 40px 20px; }
      .perfil-content { padding: 25px; }
      .perfil-header h3 { font-size: 28px; }
      .header h2 { font-size: 24px; }
      .form-input { max-width: 100%; }
      .editar-form { max-width: 100%; }
      .edit-buttons {
        flex-direction: column;
        align-items: center;
      }
      .btn-edit {
        width: 200px;
        justify-content: center;
      }
      .form-actions {
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
  <div class="header">
    <h2>ð¤ Perfil de Usuario</h2>
    <a href="home.html"><button class="logout-btn">Volver</button></a>
  </div>

  <div class="perfil-card">
    <div class="perfil-header">
      <h3 id="nombrePerfil">Nombre</h3>
      
      <!-- BiografÃ­a -->
      <div class="editar-container">
        <div id="biografiaDisplay" class="editar-display vacia">Sin biografÃ­a</div>
        <div id="biografiaEdit" class="editar-form">
          <textarea id="biografiaTextarea" class="form-input form-textarea" placeholder="Escribe algo sobre ti..." maxlength="500"></textarea>
          <div id="contadorCaracteres" class="contador-caracteres">0/500</div>
          <div class="form-actions">
            <button id="btnGuardarBiografia" class="btn btn-primary">ð¾ Guardar</button>
            <button id="btnCancelarBiografia" class="btn btn-secondary">â Cancelar</button>
          </div>
        </div>
        <div class="edit-buttons">
          <button id="btnEditarBiografia" class="btn-edit" style="display: none;">âï¸ Editar biografÃ­a</button>
          <button id="btnEditarNombre" class="btn-edit" style="display: none;">ð¤ Editar nombre</button>
          <button id="btnEditarContrasena" class="btn-edit" style="display: none;">ð Cambiar contraseÃ±a</button>
        </div>
      </div>

      <!-- Editar Nombre -->
      <div id="nombreEdit" class="editar-form">
        <input id="nombreInput" class="form-input" placeholder="Nuevo nombre de usuario" maxlength="50">
        <div class="form-actions">
          <button id="btnGuardarNombre" class="btn btn-primary">ð¾ Guardar</button>
          <button id="btnCancelarNombre" class="btn btn-secondary">â Cancelar</button>
        </div>
      </div>

      <!-- Editar ContraseÃ±a -->
      <div id="contrasenaEdit" class="editar-form">
        <input id="contrasenaActual" type="password" class="form-input" placeholder="ContraseÃ±a actual">
        <input id="contrasenaNueva" type="password" class="form-input" placeholder="Nueva contraseÃ±a">
        <input id="contrasenaConfirmar" type="password" class="form-input" placeholder="Confirmar nueva contraseÃ±a">
        <div class="form-actions">
          <button id="btnGuardarContrasena" class="btn btn-primary">ð¾ Guardar</button>
          <button id="btnCancelarContrasena" class="btn btn-secondary">â Cancelar</button>
        </div>
      </div>
    </div>

    <div class="perfil-content">
      <div class="perfil-datos">
        <p>ð Registrado desde: <span id="fechaPerfil"></span></p>
        
        <button id="btnSeguir" style="display:none">Seguir</button>
        
        <p class="contador">ð¥ Seguidores: <span id="contadorSeguidores">0</span></p>
        <p class="contador">â¡ï¸ Siguiendo: <span id="contadorSiguiendo">0</span></p>
        <button id="btnEnviarMensaje" class="btn btn-primary" style="display:none; margin-top: 10px; width:100%;">âï¸ Enviar Mensaje</button>
      </div>

      <!-- Account Privacy Settings -->
      <div class="profile-setting" id="accountPrivacySection" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: none;">
        <h4 style="font-weight: 600; font-size: 18px; color: #FFFFFF; margin-bottom: 15px;">ConfiguraciÃ³n de Privacidad de la Cuenta</h4>
        
        <!-- New Switch HTML -->
        <div class="switch-container" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
          <span style="color: rgba(255,255,255,0.9);">Cuenta Privada</span>
          <label class="switch">
            <input type="checkbox" id="tipoCuentaSwitch">
            <span class="slider round"></span>
          </label>
          <span style="color: rgba(255,255,255,0.9);">Cuenta PÃºblica</span>
        </div>
        <p style="font-size: 0.8em; color: rgba(255,255,255,0.7); text-align: center; margin-bottom:15px;">
          Si es PÃºblica, cualquiera puede enviarte mensajes. Si es Privada, se requieren solicitudes para nuevos chats.
        </p>
        <!-- End New Switch HTML -->

        <button id="guardarTipoCuentaBtn" class="btn btn-primary" style="width:100%;">ð¾ Guardar Preferencia</button>
        <p id="tipoCuentaFeedback" style="font-size: 0.9em; margin-top: 10px; text-align:center;"></p>
      </div>

    </div>
  </div>

  <script>
    let esPerfilPropio = false;
    let usuarioActual = null;

    // Elementos del DOM
    const btnEnviarMensaje = document.getElementById('btnEnviarMensaje');
    const biografiaDisplay = document.getElementById('biografiaDisplay');
    const biografiaEdit = document.getElementById('biografiaEdit');
    const nombreEdit = document.getElementById('nombreEdit');
    const contrasenaEdit = document.getElementById('contrasenaEdit');
    
    const biografiaTextarea = document.getElementById('biografiaTextarea');
    const nombreInput = document.getElementById('nombreInput');
    const contrasenaActual = document.getElementById('contrasenaActual');
    const contrasenaNueva = document.getElementById('contrasenaNueva');
    const contrasenaConfirmar = document.getElementById('contrasenaConfirmar');
    
    const btnEditarBiografia = document.getElementById('btnEditarBiografia');
    const btnEditarNombre = document.getElementById('btnEditarNombre');
    const btnEditarContrasena = document.getElementById('btnEditarContrasena');

    // DOM Elements for Account Type
    let tipoCuentaSwitchEl; // Renamed from tipoCuentaSelectEl
    let guardarTipoCuentaBtnEl;
    let tipoCuentaFeedbackEl;
    let accountPrivacySectionEl;

    // Event listeners
    biografiaTextarea.addEventListener('input', actualizarContador);
    
    btnEditarBiografia.addEventListener('click', () => habilitarEdicion('biografia'));
    btnEditarNombre.addEventListener('click', () => habilitarEdicion('nombre'));
    btnEditarContrasena.addEventListener('click', () => habilitarEdicion('contrasena'));
    
    document.getElementById('btnGuardarBiografia').addEventListener('click', () => guardar('biografia'));
    document.getElementById('btnGuardarNombre').addEventListener('click', () => guardar('nombre'));
    document.getElementById('btnGuardarContrasena').addEventListener('click', () => guardar('contrasena'));
    
    document.getElementById('btnCancelarBiografia').addEventListener('click', () => cancelarEdicion('biografia'));
    document.getElementById('btnCancelarNombre').addEventListener('click', () => cancelarEdicion('nombre'));
    document.getElementById('btnCancelarContrasena').addEventListener('click', () => cancelarEdicion('contrasena'));

    function actualizarContador() {
      const longitud = biografiaTextarea.value.length;
      document.getElementById('contadorCaracteres').textContent = `${longitud}/500`;
      document.getElementById('contadorCaracteres').classList.toggle('limite', longitud >= 450);
    }

    function habilitarEdicion(tipo) {
      // Ocultar todos los formularios y botones
      biografiaEdit.style.display = 'none';
      nombreEdit.style.display = 'none';
      contrasenaEdit.style.display = 'none';
      
      btnEditarBiografia.style.display = 'none';
      btnEditarNombre.style.display = 'none';
      btnEditarContrasena.style.display = 'none';

      if (tipo === 'biografia') {
        biografiaTextarea.value = biografiaDisplay.textContent === 'Sin biografÃ­a' ? '' : biografiaDisplay.textContent;
        biografiaDisplay.style.display = 'none';
        biografiaEdit.style.display = 'block';
        biografiaTextarea.focus();
        actualizarContador();
      } else if (tipo === 'nombre') {
        nombreInput.value = document.getElementById('nombrePerfil').textContent;
        nombreEdit.style.display = 'block';
        nombreInput.focus();
      } else if (tipo === 'contrasena') {
        contrasenaActual.value = '';
        contrasenaNueva.value = '';
        contrasenaConfirmar.value = '';
        contrasenaEdit.style.display = 'block';
        contrasenaActual.focus();
      }
    }

    function cancelarEdicion(tipo) {
      if (tipo === 'biografia') {
        biografiaDisplay.style.display = 'block';
        biografiaEdit.style.display = 'none';
      } else if (tipo === 'nombre') {
        nombreEdit.style.display = 'none';
      } else if (tipo === 'contrasena') {
        contrasenaEdit.style.display = 'none';
      }
      
      btnEditarBiografia.style.display = 'inline-block';
      btnEditarNombre.style.display = 'inline-block';
      btnEditarContrasena.style.display = 'inline-block';
    }

    async function guardar(tipo) {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      
      try {
        let endpoint, data, successMsg;
        
        if (tipo === 'biografia') {
          const nuevaBiografia = biografiaTextarea.value.trim();
          endpoint = `/usuarios/${id}/biografia`;
          data = { biografia: nuevaBiografia };
          successMsg = 'BiografÃ­a actualizada';
        } else if (tipo === 'nombre') {
          const nuevoNombre = nombreInput.value.trim();
          if (nuevoNombre.length < 3) {
            showNotification('El nombre debe tener al menos 3 caracteres', 'error'); return;
          }
          endpoint = `/usuarios/${id}/nombre`;
          data = { nombre: nuevoNombre };
          successMsg = 'Nombre actualizado';
        } else if (tipo === 'contrasena') {
          const actual = contrasenaActual.value.trim();
          const nueva = contrasenaNueva.value.trim();
          const confirmar = contrasenaConfirmar.value.trim();
          
          if (!actual || !nueva || !confirmar) {
            showNotification('Todos los campos son requeridos', 'error'); return;
          }
          if (nueva.length < 6) {
            showNotification('La contraseÃ±a debe tener al menos 6 caracteres', 'error'); return;
          }
          if (nueva !== confirmar) {
            showNotification('Las contraseÃ±as no coinciden', 'error'); return;
          }
          
          endpoint = `/usuarios/${id}/contrasena`;
          data = { contrasenaActual: actual, contrasenaNueva: nueva };
          successMsg = 'â ContraseÃ±a actualizada';
        }

        const res = await fetch(endpoint, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.mensaje || 'Error al actualizar');
        }

        // Actualizar la vista
        if (tipo === 'biografia') {
          const nuevaBiografia = biografiaTextarea.value.trim();
          biografiaDisplay.textContent = nuevaBiografia || 'Sin biografÃ­a';
          biografiaDisplay.classList.toggle('vacia', !nuevaBiografia);
        } else if (tipo === 'nombre') {
          document.getElementById('nombrePerfil').textContent = nombreInput.value.trim();
        }

        cancelarEdicion(tipo);
        showNotification(successMsg, 'success');
        
      } catch (error) {
        showNotification(error.message, 'error');
      }
    }

    async function cargarPerfil() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;

      // Initialize Account Type DOM elements here, as they are part of the profile card
      accountPrivacySectionEl = document.getElementById('accountPrivacySection');
      tipoCuentaSwitchEl = document.getElementById('tipoCuentaSwitch'); // Updated ID
      guardarTipoCuentaBtnEl = document.getElementById('guardarTipoCuentaBtn');
      tipoCuentaFeedbackEl = document.getElementById('tipoCuentaFeedback');

      try {
        const res = await fetch('/usuarios/' + id);
        if (!res.ok) throw new Error('Error al cargar datos del perfil');
        const usuario = await res.json(); // This is the profile being viewed
        
        document.getElementById('nombrePerfil').textContent = usuario.nombre;
        document.getElementById('fechaPerfil').textContent = new Date(usuario.fechaRegistro).toLocaleDateString();
        document.getElementById('contadorSeguidores').textContent = usuario.seguidores.length;
        document.getElementById('contadorSiguiendo').textContent = usuario.seguidos.length;

        if (usuario.biografia && usuario.biografia.trim()) {
          biografiaDisplay.textContent = usuario.biografia;
          biografiaDisplay.classList.remove('vacia');
        } else {
          biografiaDisplay.textContent = 'Sin biografÃ­a';
          biografiaDisplay.classList.add('vacia');
        }

        const sesionRes = await fetch('/usuarios/session');
        if (!sesionRes.ok) { 
            console.error("No se pudo obtener la sesiÃ³n del usuario.");
            // Potentially hide elements that depend on knowing the current user
            if(accountPrivacySectionEl) accountPrivacySectionEl.style.display = 'none';
            return; 
        }
        usuarioActual = await sesionRes.json(); // This is the logged-in user

        if (usuarioActual && usuarioActual._id === id) { // Check if logged-in user is viewing their own profile
          esPerfilPropio = true;
          btnEditarBiografia.style.display = 'inline-block';
          btnEditarNombre.style.display = 'inline-block';
          btnEditarContrasena.style.display = 'inline-block';
          
          // Show and setup account privacy settings only for own profile
          if(accountPrivacySectionEl) accountPrivacySectionEl.style.display = 'block';
          if(guardarTipoCuentaBtnEl) guardarTipoCuentaBtnEl.onclick = guardarTipoCuenta;
          cargarPreferenciasUsuario(); // Load current preference into select

        } else { // Viewing another user's profile
          esPerfilPropio = false;
          if(accountPrivacySectionEl) accountPrivacySectionEl.style.display = 'none'; // Hide privacy settings
          const sigue = usuario.seguidores.some(seg => seg._id === usuarioActual._id);
          const btn = document.getElementById('btnSeguir');
          if (btn) { // Ensure button exists before manipulating
            btn.style.display = 'inline-block';
            btn.textContent = sigue ? 'Dejar de seguir' : 'Seguir';
            btn.classList.toggle('dejar', sigue);
            btn.onclick = async () => {
              const resSeguir = await fetch(`/usuarios/${id}/seguir`, { method: 'POST' });
              if (resSeguir.ok) cargarPerfil(); 
            };
          }
        }

        // LÃ³gica para el botÃ³n de Enviar Mensaje
        if (usuarioActual && usuarioActual._id !== id) { 
            if(btnEnviarMensaje) {
                btnEnviarMensaje.style.display = 'block'; 
                btnEnviarMensaje.onclick = () => {
                    window.location.href = `mensajes.html?chatWith=${id}&chatWithNombre=${encodeURIComponent(usuario.nombre)}`;
                };
            }
        } else if (btnEnviarMensaje) { 
            btnEnviarMensaje.style.display = 'none';
        }

      } catch (e) {
        showNotification(e.message || 'No se pudo cargar el perfil', 'error');
        // Consider not redirecting immediately, maybe show error on page
        // window.location.href = 'home.html'; 
      }
    }

    async function cargarPreferenciasUsuario() {
      if (usuarioActual && tipoCuentaSwitchEl) { // Check if usuarioActual and the switch element exist
        if (typeof usuarioActual.tipoCuenta !== 'undefined') {
          tipoCuentaSwitchEl.checked = (usuarioActual.tipoCuenta === 'publica');
        } else {
          console.warn('Tipo de cuenta no encontrado en datos de sesiÃ³n para cargar preferencia del switch.');
          // Default to false (privada) if not defined, or handle as error
          tipoCuentaSwitchEl.checked = false; 
        }
      } else if (tipoCuentaFeedbackEl) { // Only use feedbackEl if it exists
        console.warn('Switch o datos de usuario no disponibles para cargar preferencias.');
      }
    }

    async function guardarTipoCuenta() {
      if (!tipoCuentaSwitchEl || !tipoCuentaFeedbackEl) return; // Ensure elements exist
       
      const nuevoTipoCuenta = tipoCuentaSwitchEl.checked ? 'publica' : 'privada'; // Determine from checkbox state
       
      tipoCuentaFeedbackEl.textContent = ''; 

      try {
        const response = await fetch('/usuarios/me/tipoCuenta', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipoCuenta: nuevoTipoCuenta }) // Send string value
        });
         
        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Error del servidor');
        }
         
        tipoCuentaFeedbackEl.textContent = result.mensaje || 'Preferencia guardada.';
        tipoCuentaFeedbackEl.style.color = 'green';
        if(usuarioActual) usuarioActual.tipoCuenta = nuevoTipoCuenta; // Update local state

      } catch (error) {
        console.error('Error guardando tipo de cuenta:', error);
        tipoCuentaFeedbackEl.textContent = error.message || 'Error al guardar la preferencia.';
        tipoCuentaFeedbackEl.style.color = 'red';
        // Revert checkbox state if possible
        if (usuarioActual && typeof usuarioActual.tipoCuenta !== 'undefined') {
           tipoCuentaSwitchEl.checked = (usuarioActual.tipoCuenta === 'publica');
        }
      }
    }

    cargarPerfil();
    // Removed setInterval for reloading other user's profile, as it can be disruptive.
    // A manual refresh or other UX would be better for that.
    // setInterval(() => {
    //  if (!esPerfilPropio) cargarPerfil();
    // }, 3000);
  </script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script type="text/javascript" src="notifications.js"></script>
</body>
</html>