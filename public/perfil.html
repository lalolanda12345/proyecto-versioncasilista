<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil de Usuario</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                  radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      max-width: 800px;
      margin: 0 auto 30px;
    }

    .header h2 {
      color: white;
      font-weight: 700;
      font-size: 28px;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logout-btn, .btn-edit {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin: 5px;
    }

    .logout-btn::before, .btn-edit::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .logout-btn:hover::before, .btn-edit:hover::before {
      left: 100%;
    }

    .logout-btn:hover, .btn-edit:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .perfil-card {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(30px);
      border-radius: 32px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .perfil-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      padding: 50px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .perfil-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: rotate 10s linear infinite;
      opacity: 0.5;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .perfil-header h3 {
      font-size: 36px;
      color: white;
      font-weight: 700;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
      position: relative;
      z-index: 1;
      animation: fadeInUp 0.8s ease-out;
    }

    .editar-container {
      position: relative;
      z-index: 1;
      margin-top: 15px;
    }

    .editar-display {
      color: rgba(255,255,255,0.9);
      font-size: 16px;
      line-height: 1.5;
      font-style: italic;
      max-width: 600px;
      margin: 0 auto;
      word-wrap: break-word;
    }

    .editar-display.vacia {
      opacity: 0.5;
    }

    .editar-form {
      display: none;
      margin-top: 15px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .form-input {
      width: 100%;
      min-height: 48px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      color: white;
      font-family: inherit;
      font-size: 16px;
      padding: 12px 18px;
      margin-bottom: 12px;
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .form-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .form-input:focus {
      outline: none;
      border-color: rgba(100, 181, 246, 0.8);
      box-shadow: 0 0 0 2px rgba(100, 181, 246, 0.2), 0 8px 25px rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }

    select#tipoCuentaSelect option {
      background-color: #1a1a2e; /* Dark background from body gradient */
      color: #FFFFFF;           /* White text */
      /* Padding or other properties might not be consistently applied by browsers */
    }

    select#tipoCuentaSelect option:hover {
        background-color: #3b82f6; /* Example primary blue, for hover, if supported */
        color: #FFFFFF;
    }

/* Styles for the switch container (if needed beyond inline) */
.switch-container {
  /* display: flex; already inline */
  /* align-items: center; already inline */
  /* justify-content: space-between; already inline */
  margin-bottom: 10px; /* Reduced from 15px on the select */
}

/* The switch - a label element */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;  /* Width of the switch track */
  height: 34px; /* Height of the switch track */
  flex-shrink: 0; /* Prevent shrinking if container is too small */
}

/* Hide default HTML checkbox */
.switch input#tipoCuentaSwitch {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider (track and knob) */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255,255,255,0.1); /* Track color when off (Privada) - similar to form input borders */
  border: 1px solid rgba(255,255,255,0.2);
  -webkit-transition: .4s;
  transition: .4s;
  border-radius: 16px; /* Rounded track */
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px; /* Height of the knob */
  width: 26px;  /* Width of the knob */
  left: 4px;    /* Position of the knob when off */
  bottom: 3px;  /* Position of the knob when off (considering border) */
  background-color: white; /* Knob color */
  -webkit-transition: .4s;
  transition: .4s;
  border-radius: 12px; /* Rounded knob */
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

input#tipoCuentaSwitch:checked + .slider {
  background-color: #3b82f6; /* Track color when on (P√∫blica) - primary blue */
  border-color: #60a5fa;
}

input#tipoCuentaSwitch:focus + .slider {
  box-shadow: 0 0 1px #3b82f6, 0 0 0 2px rgba(59, 130, 246, 0.2); /* Focus outline consistent with form-input */
}

input#tipoCuentaSwitch:checked + .slider:before {
  -webkit-transform: translateX(26px); /* Move knob to the right when on */
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Adjustments for the descriptive paragraph below the switch */
#accountPrivacySection > p { /* Targeting the <p> directly under accountPrivacySection */
    font-size: 0.8em; 
    color: rgba(255,255,255,0.7); 
    text-align: center; 
    /* margin-bottom is already inline, but can be centralized here if preferred */
    /* margin-bottom: 15px; */ 
    line-height: 1.4;
}

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    /* Botones actualizados con estilo azul para guardar */
    .btn {
      margin: 6px; 
      padding: 12px 20px; 
      border: none; 
      color: #fff; 
      border-radius: 12px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      font-size: 14px;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover { 
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
    }
    
    .btn-primary:hover { 
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .btn-secondary:hover { 
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .contador-caracteres {
      text-align: center;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin-top: 8px;
      font-weight: 500;
    }

    .contador-caracteres.limite {
      color: rgba(239, 68, 68, 0.8);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .perfil-content {
      padding: 40px 30px;
    }

    .perfil-datos p {
      font-size: 16px;
      margin: 20px 0;
      color: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    .perfil-datos p:hover {
      background: rgba(255,255,255,0.08);
      transform: translateX(5px);
    }

    .contador {
      font-weight: 600;
      font-size: 18px;
      margin: 20px 0;
      color: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .contador span {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    #btnSeguir {
      margin-top: 30px;
      padding: 16px 32px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: white;
      font-weight: 700;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      position: relative;
      overflow: hidden;
    }

    #btnSeguir::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    #btnSeguir:hover::before {
      left: 100%;
    }

    #btnSeguir:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(16, 185, 129, 0.5);
    }

    #btnSeguir.dejar {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    #btnSeguir.dejar:hover {
      box-shadow: 0 15px 30px rgba(239, 68, 68, 0.5);
    }

    .edit-buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }

    @media (max-width: 600px) {
      .perfil-card { margin: 20px; }
      .perfil-header { padding: 40px 20px; }
      .perfil-content { padding: 25px; }
      .perfil-header h3 { font-size: 28px; }
      .header h2 { font-size: 24px; }
      .form-input { max-width: 100%; }
      .editar-form { max-width: 100%; }
      .edit-buttons {
        flex-direction: column;
        align-items: center;
      }
      .btn-edit {
        width: 200px;
        justify-content: center;
      }
      .form-actions {
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    .settings-columns-wrapper {
      display: flex;
      align-items: flex-start; /* Align items to the top of each column */
      width: 100%;
      gap: 20px; /* Space between the columns */
    }

    .settings-column {
      flex: 1; /* Each column will take up equal available space */
    }

    /* Responsive adjustments */
    @media (max-width: 768px) { /* Breakpoint for stacking columns */
      .settings-columns-wrapper {
        flex-direction: column;
        gap: 15px; /* Adjust gap for stacked layout */
      }
      .settings-column-left {
        margin-bottom: 15px; /* Add space below the privacy column when stacked */
      }
      .settings-column-right {
        margin-bottom: 0; /* Ensure no extra margin for the last item */
      }
    }

    @media (min-width: 769px) { /* Screen wider than 768px */
        .settings-column-left {
            margin-bottom: 0px; /* Remove space below the privacy column when side by side */
        }
    }

    /* Styling for the new trigger icon button */
    .icon-btn {
        padding: 8px 12px; /* Adjust padding for icon */
        font-size: 1.2rem; /* Make bell icon larger */
        margin-left: 10px; /* Space from title or previous element */
    }

    /* Ensure header can act as a positioning context */
    .header {
        position: relative; /* Needed for absolute positioning of the inbox panel */
    }

    /* Styling for the inbox panel */
    .inbox-panel {
        position: absolute;
        top: calc(100% + 5px); /* Position below the header with a small gap */
        right: 0;
        width: 300px; /* Adjust as needed */
        max-height: 400px; /* Limit height */
        overflow-y: auto; /* Scroll for overflow */
        background: rgba(30, 30, 50, 0.9); /* Darker, more opaque for readability */
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        padding: 15px;
        z-index: 100; /* Ensure it's above other content */
        color: #e0e0e0;
    }

    .inbox-panel h4 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1rem;
        font-weight: 600;
        color: #ffffff;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 8px;
    }

    .inbox-panel .inbox-request-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        font-size: 0.9rem;
    }

    .inbox-panel .inbox-request-item:last-child {
        border-bottom: none;
    }

    .inbox-panel .requester-name {
        flex-grow: 1;
    }

    .inbox-panel .actions button {
        padding: 5px 10px;
        margin-left: 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background-color 0.2s;
    }

    .inbox-panel .btn-accept-inbox {
        background-color: #28a745;
        color: white;
    }
    .inbox-panel .btn-accept-inbox:hover {
        background-color: #218838;
    }

    .inbox-panel .btn-decline-inbox {
        background-color: #dc3545;
        color: white;
    }
    .inbox-panel .btn-decline-inbox:hover {
        background-color: #c82333;
    }
    
    .inbox-panel .no-requests-message {
        text-align: center;
        padding: 10px;
        color: #aaa;
    }

    .inbox-panel .view-all-link {
        display: block;
        text-align: center;
        margin-top: 10px;
        padding: 8px;
        background: rgba(255,255,255,0.05);
        color: #64b5f6;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.85rem;
        transition: background-color 0.2s;
    }
    .inbox-panel .view-all-link:hover {
        background: rgba(255,255,255,0.1);
    }
  </style>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
  <div class="header">
    <h2>üë§ Perfil de Usuario</h2>
    <button id="inboxTriggerBtn" class="logout-btn icon-btn" aria-label="Follow Requests" style="display: none;">üîî</button>
    <a href="home.html"><button class="logout-btn">Volver</button></a>
    <div id="followRequestsInbox" class="inbox-panel" style="display: none;">
        <h4>Solicitudes de Seguimiento</h4>
        <div id="inboxRequestsList">
            <!-- Requests will be populated here -->
            <p class="no-requests-message" style="display: none;">No tienes solicitudes pendientes.</p>
        </div>
        <a href="solicitudes.html" class="view-all-link">Ver todas</a>
    </div>
  </div>

  <div class="perfil-card">
    <div class="perfil-header">
      <h3 id="nombrePerfil">Nombre</h3>
      <button id="btnConfiguracion" class="btn-edit" style="margin-top: 10px; display: none;">‚öôÔ∏è Configuraci√≥n</button>
      
      <!-- Biograf√≠a -->
      <div class="editar-container">
        <div id="biografiaDisplay" class="editar-display vacia">Sin biograf√≠a</div>
        <div id="biografiaEdit" class="editar-form">
          <textarea id="biografiaTextarea" class="form-input form-textarea" placeholder="Escribe algo sobre ti..." maxlength="500"></textarea>
          <div id="contadorCaracteres" class="contador-caracteres">0/500</div>
          <div class="form-actions">
            <button id="btnGuardarBiografia" class="btn btn-primary">üíæ Guardar</button>
            <button id="btnCancelarBiografia" class="btn btn-secondary">‚ùå Cancelar</button>
          </div>
        </div>
        <!-- The .edit-buttons div will be moved -->
      </div>

      <!-- Editar Nombre -->
      <div id="nombreEdit" class="editar-form">
        <input id="nombreInput" class="form-input" placeholder="Nuevo nombre de usuario" maxlength="50">
        <div class="form-actions">
          <button id="btnGuardarNombre" class="btn btn-primary">üíæ Guardar</button>
          <button id="btnCancelarNombre" class="btn btn-secondary">‚ùå Cancelar</button>
        </div>
      </div>

      <!-- Editar Contrase√±a -->
      <div id="contrasenaEdit" class="editar-form">
        <input id="contrasenaActual" type="password" class="form-input" placeholder="Contrase√±a actual">
        <input id="contrasenaNueva" type="password" class="form-input" placeholder="Nueva contrase√±a">
        <input id="contrasenaConfirmar" type="password" class="form-input" placeholder="Confirmar nueva contrase√±a">
        <div class="form-actions">
          <button id="btnGuardarContrasena" class="btn btn-primary">üíæ Guardar</button>
          <button id="btnCancelarContrasena" class="btn btn-secondary">‚ùå Cancelar</button>
        </div>
      </div>
    </div>

    <div class="perfil-content">
      <div id="configuracionSection" style="display: none; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.08);">
        <div class="settings-columns-wrapper">
            <div class="settings-column settings-column-left">
                <div class="profile-setting" id="accountPrivacySection" style="margin-top: 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: none;">
                    <h4 style="font-weight: 600; font-size: 18px; color: #FFFFFF; margin-bottom: 15px;">Configuraci√≥n de Privacidad de la Cuenta</h4>
                    
                    <div class="switch-container" style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 15px;">
                      <span style="color: rgba(255,255,255,0.9);">Cuenta Privada</span>
                      <label class="switch" style="margin-left: 10px;">
                        <input type="checkbox" id="tipoCuentaSwitch">
                        <span class="slider round"></span>
                      </label>
                    </div>
                    <p style="font-size: 0.8em; color: rgba(255,255,255,0.7); text-align: center; margin-bottom:15px;">
                      Si es P√∫blica, cualquiera puede enviarte mensajes. Si es Privada, se requieren solicitudes para nuevos chats.
                    </p>
        
                    <button id="guardarTipoCuentaBtn" class="btn btn-primary" style="width:100%;">üíæ Guardar Preferencia</button>
                  </div>
            </div>
            <div class="settings-column settings-column-right">
                <div class="edit-buttons" style="margin-top: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;">
                    <button id="btnEditarBiografia" class="btn-edit" style="display: none;">‚úèÔ∏è Editar biograf√≠a</button>
                    <button id="btnEditarNombre" class="btn-edit" style="display: none;">üë§ Editar nombre</button>
                    <button id="btnEditarContrasena" class="btn-edit" style="display: none;">üîí Cambiar contrase√±a</button>
                </div>
            </div>
        </div>
      </div>
      <div class="perfil-datos">
        <p>üìÖ Registrado desde: <span id="fechaPerfil"></span></p>
        
        <button id="btnSeguir" style="display:none">Seguir</button>
        
        <p class="contador">üë• Seguidores: <span id="contadorSeguidores">0</span></p>
        <p class="contador">‚û°Ô∏è Siguiendo: <span id="contadorSiguiendo">0</span></p>
        <button id="btnEnviarMensaje" class="btn btn-primary" style="display:none; margin-top: 10px; width:100%;">‚úâÔ∏è Enviar Mensaje</button>
      </div>

      <!-- Account Privacy Settings has been moved into configuracionSection -->

    </div>
  </div>

  <script>
    let esPerfilPropio = false;
    let usuarioActual = null;

    // Elementos del DOM
    const btnEnviarMensaje = document.getElementById('btnEnviarMensaje');
    const biografiaDisplay = document.getElementById('biografiaDisplay');
    const biografiaEdit = document.getElementById('biografiaEdit');
    const nombreEdit = document.getElementById('nombreEdit');
    const contrasenaEdit = document.getElementById('contrasenaEdit');
    
    const biografiaTextarea = document.getElementById('biografiaTextarea');
    const nombreInput = document.getElementById('nombreInput');
    const contrasenaActual = document.getElementById('contrasenaActual');
    const contrasenaNueva = document.getElementById('contrasenaNueva');
    const contrasenaConfirmar = document.getElementById('contrasenaConfirmar');
    
    const btnEditarBiografia = document.getElementById('btnEditarBiografia');
    const btnEditarNombre = document.getElementById('btnEditarNombre');
    const btnEditarContrasena = document.getElementById('btnEditarContrasena');
    const btnConfiguracion = document.getElementById('btnConfiguracion');
    const configuracionSection = document.getElementById('configuracionSection');

    // DOM Elements for Account Type
    let tipoCuentaSwitchEl; // Renamed from tipoCuentaSelectEl
    let guardarTipoCuentaBtnEl;
    // let tipoCuentaFeedbackEl; // No longer used - this line was present in the file
    let accountPrivacySectionEl;

    // Inbox elements
    let inboxTriggerBtnEl;
    let followRequestsInboxEl;
    let inboxRequestsListEl;
    let noRequestsMessageEl;

    // Event listeners
    biografiaTextarea.addEventListener('input', actualizarContador);
    
    btnEditarBiografia.addEventListener('click', () => habilitarEdicion('biografia'));
    btnEditarNombre.addEventListener('click', () => habilitarEdicion('nombre'));
    btnEditarContrasena.addEventListener('click', () => habilitarEdicion('contrasena'));
    if (btnConfiguracion) btnConfiguracion.addEventListener('click', toggleConfiguracion);
    
    document.getElementById('btnGuardarBiografia').addEventListener('click', () => guardar('biografia'));
    document.getElementById('btnGuardarNombre').addEventListener('click', () => guardar('nombre'));
    document.getElementById('btnGuardarContrasena').addEventListener('click', () => guardar('contrasena'));
    
    document.getElementById('btnCancelarBiografia').addEventListener('click', () => cancelarEdicion('biografia'));
    document.getElementById('btnCancelarNombre').addEventListener('click', () => cancelarEdicion('nombre'));
    document.getElementById('btnCancelarContrasena').addEventListener('click', () => cancelarEdicion('contrasena'));

    function actualizarContador() {
      const longitud = biografiaTextarea.value.length;
      document.getElementById('contadorCaracteres').textContent = `${longitud}/500`;
      document.getElementById('contadorCaracteres').classList.toggle('limite', longitud >= 450);
    }

    function habilitarEdicion(tipo) {
      // Ocultar todos los formularios y botones
      biografiaEdit.style.display = 'none';
      nombreEdit.style.display = 'none';
      contrasenaEdit.style.display = 'none';
      
      // Ensure configuracionSection is open if not already
      if (configuracionSection && configuracionSection.style.display === 'none') {
        // This will open the section and also call showEditButtons, 
        // but we are about to hide them again for the form.
        toggleConfiguracion(); 
      }
      
      // Explicitly hide main edit buttons as a specific form is opening.
      btnEditarBiografia.style.display = 'none';
      btnEditarNombre.style.display = 'none';
      btnEditarContrasena.style.display = 'none';

      if (tipo === 'biografia') {
        biografiaTextarea.value = biografiaDisplay.textContent === 'Sin biograf√≠a' ? '' : biografiaDisplay.textContent;
        biografiaDisplay.style.display = 'none';
        biografiaEdit.style.display = 'block';
        biografiaTextarea.focus();
        actualizarContador();
      } else if (tipo === 'nombre') {
        nombreInput.value = document.getElementById('nombrePerfil').textContent;
        nombreEdit.style.display = 'block';
        nombreInput.focus();
      } else if (tipo === 'contrasena') {
        contrasenaActual.value = '';
        contrasenaNueva.value = '';
        contrasenaConfirmar.value = '';
        contrasenaEdit.style.display = 'block';
        contrasenaActual.focus();
      }
    }

    function cancelarEdicion(tipo) {
      if (tipo === 'biografia') {
        biografiaDisplay.style.display = 'block';
        biografiaEdit.style.display = 'none';
      } else if (tipo === 'nombre') {
        nombreEdit.style.display = 'none';
      } else if (tipo === 'contrasena') {
        contrasenaEdit.style.display = 'none';
      }
      showEditButtons(); // Ensure edit buttons are visible if config section is open
    }

    function toggleConfiguracion() {
      if (!configuracionSection) return;
      const isVisible = configuracionSection.style.display === 'block';
      configuracionSection.style.display = isVisible ? 'none' : 'block';

      if (isVisible) { // If section is being hidden
        biografiaEdit.style.display = 'none';
        nombreEdit.style.display = 'none';
        contrasenaEdit.style.display = 'none';
        if (biografiaDisplay.style.display === 'none' && !biografiaEdit.style.display === 'block') {
            biografiaDisplay.style.display = 'block'; // Restore biografia display
        }
        if (accountPrivacySectionEl) accountPrivacySectionEl.style.display = 'none';
      } else { // If section is being shown
        showEditButtons();
        if (esPerfilPropio && accountPrivacySectionEl) {
          accountPrivacySectionEl.style.display = 'block';
        }
      }
    }

    function showEditButtons() {
      const formActivo = biografiaEdit.style.display === 'block' ||
                         nombreEdit.style.display === 'block' ||
                         contrasenaEdit.style.display === 'block';

      if (esPerfilPropio && configuracionSection && configuracionSection.style.display === 'block' && !formActivo) {
        btnEditarBiografia.style.display = 'inline-block';
        btnEditarNombre.style.display = 'inline-block';
        btnEditarContrasena.style.display = 'inline-block';
      } else {
        btnEditarBiografia.style.display = 'none';
        btnEditarNombre.style.display = 'none';
        btnEditarContrasena.style.display = 'none';
      }
    }

    async function guardar(tipo) {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      
      try {
        let endpoint, data, successMsg;
        
        if (tipo === 'biografia') {
          const nuevaBiografia = biografiaTextarea.value.trim();
          endpoint = `/usuarios/${id}/biografia`;
          data = { biografia: nuevaBiografia };
          successMsg = 'Biograf√≠a actualizada';
        } else if (tipo === 'nombre') {
          const nuevoNombre = nombreInput.value.trim();
          if (nuevoNombre.length < 3) {
            showNotification('El nombre debe tener al menos 3 caracteres', 'error'); return;
          }
          endpoint = `/usuarios/${id}/nombre`;
          data = { nombre: nuevoNombre };
          successMsg = 'Nombre actualizado';
        } else if (tipo === 'contrasena') {
          const actual = contrasenaActual.value.trim();
          const nueva = contrasenaNueva.value.trim();
          const confirmar = contrasenaConfirmar.value.trim();
          
          if (!actual || !nueva || !confirmar) {
            showNotification('Todos los campos son requeridos', 'error'); return;
          }
          if (nueva.length < 6) {
            showNotification('La contrase√±a debe tener al menos 6 caracteres', 'error'); return;
          }
          if (nueva !== confirmar) {
            showNotification('Las contrase√±as no coinciden', 'error'); return;
          }
          
          endpoint = `/usuarios/${id}/contrasena`;
          data = { contrasenaActual: actual, contrasenaNueva: nueva };
          successMsg = '‚úÖ Contrase√±a actualizada';
        }

        const res = await fetch(endpoint, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.mensaje || 'Error al actualizar');
        }

        // Actualizar la vista
        if (tipo === 'biografia') {
          const nuevaBiografia = biografiaTextarea.value.trim();
          biografiaDisplay.textContent = nuevaBiografia || 'Sin biograf√≠a';
          biografiaDisplay.classList.toggle('vacia', !nuevaBiografia);
        } else if (tipo === 'nombre') {
          document.getElementById('nombrePerfil').textContent = nombreInput.value.trim();
        }

        cancelarEdicion(tipo);
        showNotification(successMsg, 'success');
        
      } catch (error) {
        showNotification(error.message, 'error');
      }
    }

    async function cargarPerfil() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;

      // Initialize Account Type DOM elements here, as they are part of the profile card
      accountPrivacySectionEl = document.getElementById('accountPrivacySection');
      tipoCuentaSwitchEl = document.getElementById('tipoCuentaSwitch'); // Updated ID
      guardarTipoCuentaBtnEl = document.getElementById('guardarTipoCuentaBtn');
      // tipoCuentaFeedbackEl = document.getElementById('tipoCuentaFeedback'); // No longer used

      // Initialize Inbox elements
      inboxTriggerBtnEl = document.getElementById('inboxTriggerBtn');
      followRequestsInboxEl = document.getElementById('followRequestsInbox');
      inboxRequestsListEl = document.getElementById('inboxRequestsList');
      if (followRequestsInboxEl) { // Ensure followRequestsInboxEl exists before querying
        noRequestsMessageEl = followRequestsInboxEl.querySelector('.no-requests-message');
      }

      if (inboxTriggerBtnEl) {
          inboxTriggerBtnEl.addEventListener('click', toggleFollowRequestsInbox);
      }

      try {
        const res = await fetch('/usuarios/' + id);
        if (!res.ok) throw new Error('Error al cargar datos del perfil');
        const usuario = await res.json(); // This is the profile being viewed
        
        document.getElementById('nombrePerfil').textContent = usuario.nombre;
        document.getElementById('fechaPerfil').textContent = new Date(usuario.fechaRegistro).toLocaleDateString();
        document.getElementById('contadorSeguidores').textContent = usuario.seguidores.length;
        document.getElementById('contadorSiguiendo').textContent = usuario.seguidos.length;

        if (usuario.biografia && usuario.biografia.trim()) {
          biografiaDisplay.textContent = usuario.biografia;
          biografiaDisplay.classList.remove('vacia');
        } else {
          biografiaDisplay.textContent = 'Sin biograf√≠a';
          biografiaDisplay.classList.add('vacia');
        }

        const sesionRes = await fetch('/usuarios/session');
        if (!sesionRes.ok) { 
            console.error("No se pudo obtener la sesi√≥n del usuario.");
            // Potentially hide elements that depend on knowing the current user
            if(accountPrivacySectionEl) accountPrivacySectionEl.style.display = 'none';
            return; 
        }
        usuarioActual = await sesionRes.json(); // This is the logged-in user

        if (usuarioActual && usuarioActual._id === id) { // Check if logged-in user is viewing their own profile
          esPerfilPropio = true;
          if(btnConfiguracion) btnConfiguracion.style.display = 'inline-block'; // Show settings button
          if (inboxTriggerBtnEl) {
            inboxTriggerBtnEl.style.display = 'inline-flex'; 
          }
          // Edit buttons are now inside configuracionSection, shown/hidden by toggleConfiguracion & showEditButtons
          
          // Setup account privacy settings. Visibility is handled by toggleConfiguracion
          if(guardarTipoCuentaBtnEl) guardarTipoCuentaBtnEl.onclick = guardarTipoCuenta;
          cargarPreferenciasUsuario(); 
          // Ensure edit buttons are hidden initially if config section is hidden
          showEditButtons(); 
          // Ensure privacy section is hidden initially if config section is hidden
          if (configuracionSection && configuracionSection.style.display !== 'block' && accountPrivacySectionEl) {
            accountPrivacySectionEl.style.display = 'none';
          }


        } else { // Viewing another user's profile
          esPerfilPropio = false;
          if(btnConfiguracion) btnConfiguracion.style.display = 'none'; // Hide settings button
          if(configuracionSection) configuracionSection.style.display = 'none'; // Ensure settings section is hidden
          if(accountPrivacySectionEl) accountPrivacySectionEl.style.display = 'none'; // Ensure privacy settings are hidden
          if (inboxTriggerBtnEl) {
            inboxTriggerBtnEl.style.display = 'none';
          }
          
          const btnSeguir = document.getElementById('btnSeguir');
          if (btnSeguir) {
              btnSeguir.style.display = 'inline-block';
              btnSeguir.disabled = false; // Reset disabled state

              const yaSigue = usuario.seguidores.some(seg => seg._id === usuarioActual._id);

              if (yaSigue) {
                  btnSeguir.textContent = 'Dejar de seguir';
                  btnSeguir.classList.add('dejar');
                  btnSeguir.onclick = async () => {
                      const resUnfollow = await fetch(`/usuarios/${id}/seguir`, { method: 'POST' });
                      if (resUnfollow.ok) cargarPerfil(); // Reload profile to update state
                  };
              } else {
                  // Not yet following
                  if (usuario.tipoCuenta === 'privada') {
                      btnSeguir.textContent = 'Solicitar seguimiento';
                      btnSeguir.classList.remove('dejar'); // Ensure it's not styled as 'dejar' initially
                      btnSeguir.onclick = async () => {
                          try {
                              const resSolicitud = await fetch(`/api/solicitudes-seguimiento/${id}`, { 
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' }
                              });
                              const resultado = await resSolicitud.json();

                              if (resSolicitud.ok) {
                                  showNotification(resultado.mensaje || 'Solicitud enviada.', 'success');
                                  btnSeguir.textContent = 'Solicitud enviada';
                                  btnSeguir.disabled = true;
                                  btnSeguir.classList.add('dejar'); // Use 'dejar' style for pending
                              } else {
                                  showNotification(resultado.mensaje || 'No se pudo enviar la solicitud.', 'error');
                                  if (resultado.mensaje && resultado.mensaje.toLowerCase().includes('pendiente')) {
                                       btnSeguir.textContent = 'Solicitud enviada';
                                       btnSeguir.disabled = true;
                                       btnSeguir.classList.add('dejar');
                                  }
                              }
                          } catch (err) {
                              console.error("Error sending follow request:", err);
                              showNotification('Error al conectar con el servidor.', 'error');
                          }
                      };
                  } else { // Public account or tipoCuenta not defined
                      btnSeguir.textContent = 'Seguir';
                      btnSeguir.classList.remove('dejar');
                      btnSeguir.onclick = async () => {
                          const resFollow = await fetch(`/usuarios/${id}/seguir`, { method: 'POST' });
                          if (resFollow.ok) cargarPerfil(); // Reload profile to update state
                      };
                  }
              }
          }
        }

        // L√≥gica para el bot√≥n de Enviar Mensaje
        if (usuarioActual && usuarioActual._id !== id) { 
            if(btnEnviarMensaje) {
                btnEnviarMensaje.style.display = 'block'; 
                btnEnviarMensaje.onclick = () => {
                    window.location.href = `mensajes.html?chatWith=${id}&chatWithNombre=${encodeURIComponent(usuario.nombre)}`;
                };
            }
        } else if (btnEnviarMensaje) { 
            btnEnviarMensaje.style.display = 'none';
        }

      } catch (e) {
        showNotification(e.message || 'No se pudo cargar el perfil', 'error');
        // Consider not redirecting immediately, maybe show error on page
        // window.location.href = 'home.html'; 
      }
    }

    async function cargarPreferenciasUsuario() {
      if (usuarioActual && tipoCuentaSwitchEl) { // Check if usuarioActual and the switch element exist
        if (typeof usuarioActual.tipoCuenta !== 'undefined') {
          tipoCuentaSwitchEl.checked = (usuarioActual.tipoCuenta === 'privada');
        } else {
          console.warn('Tipo de cuenta no encontrado en datos de sesi√≥n para cargar preferencia del switch.');
          // Default to false (privada) if not defined, or handle as error
          tipoCuentaSwitchEl.checked = false; 
        }
      } else { // Removed else if (tipoCuentaFeedbackEl) as it's no longer used.
        console.warn('Switch o datos de usuario no disponibles para cargar preferencias.');
      }
    }

    async function guardarTipoCuenta() {
      if (!tipoCuentaSwitchEl) return; // Ensure elements exist
       
      const nuevoTipoCuenta = tipoCuentaSwitchEl.checked ? 'privada' : 'publica'; // Determine from checkbox state

      try {
        const response = await fetch('/usuarios/me/tipoCuenta', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipoCuenta: nuevoTipoCuenta }) // Send string value
        });
         
        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Error del servidor');
        }
         
        showNotification('Guardado exitosamente', 'success');
        if(usuarioActual) usuarioActual.tipoCuenta = nuevoTipoCuenta; // Update local state

      } catch (error) {
        console.error('Error guardando tipo de cuenta:', error);
        showNotification(error.message || 'Error al guardar la preferencia.', 'error');
        // Revert checkbox state if possible
        if (usuarioActual && typeof usuarioActual.tipoCuenta !== 'undefined') {
           tipoCuentaSwitchEl.checked = (usuarioActual.tipoCuenta === 'privada');
        }
      }
    }

    cargarPerfil();
    // Removed setInterval for reloading other user's profile, as it can be disruptive.
    // A manual refresh or other UX would be better for that.
    // setInterval(() => {
    //  if (!esPerfilPropio) cargarPerfil();
    // }, 3000);

    function toggleFollowRequestsInbox() {
        if (!followRequestsInboxEl) return;
        const isVisible = followRequestsInboxEl.style.display === 'block';
        followRequestsInboxEl.style.display = isVisible ? 'none' : 'block';
        if (!isVisible && inboxRequestsListEl && inboxRequestsListEl.children.length <= 1) { // Only fetch if opening and list is empty (or only has no-requests message)
            cargarSolicitudesInbox();
        }
    }

    async function cargarSolicitudesInbox() {
        if (!inboxRequestsListEl || !noRequestsMessageEl) return;
        
        // Clear previous list but preserve the 'no requests' message element
        while (inboxRequestsListEl.firstChild && !inboxRequestsListEl.firstChild.isSameNode(noRequestsMessageEl)) {
            inboxRequestsListEl.removeChild(inboxRequestsListEl.firstChild);
        }
        noRequestsMessageEl.style.display = 'none'; // Hide it initially

        try {
            const res = await fetch('/api/solicitudes-seguimiento/recibidas');
            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.mensaje || 'Error al cargar solicitudes de seguimiento');
            }
            const solicitudes = await res.json();

            if (solicitudes.length === 0) {
                noRequestsMessageEl.textContent = 'No tienes solicitudes pendientes.'; // Ensure default message
                noRequestsMessageEl.style.display = 'block';
                return;
            }

            solicitudes.forEach(solicitud => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inbox-request-item';
                itemDiv.id = `inbox-solicitud-${solicitud._id}`;

                const userInfo = document.createElement('span');
                userInfo.className = 'requester-name';
                userInfo.textContent = `${solicitud.solicitante.nombre} quiere seguirte.`;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'actions';

                const btnAceptar = document.createElement('button');
                btnAceptar.className = 'btn-accept-inbox';
                btnAceptar.textContent = 'Aceptar';
                btnAceptar.onclick = () => manejarSolicitudInbox(solicitud._id, 'aceptar');

                const btnRechazar = document.createElement('button');
                btnRechazar.className = 'btn-decline-inbox';
                btnRechazar.textContent = 'Rechazar';
                btnRechazar.onclick = () => manejarSolicitudInbox(solicitud._id, 'rechazar');

                actionsDiv.appendChild(btnAceptar);
                actionsDiv.appendChild(btnRechazar);
                itemDiv.appendChild(userInfo);
                itemDiv.appendChild(actionsDiv);
                // Prepend to show newest first, or append if order from API is already desired
                inboxRequestsListEl.insertBefore(itemDiv, noRequestsMessageEl); 
            });

        } catch (error) {
            console.error('Error cargando solicitudes en inbox:', error);
            noRequestsMessageEl.textContent = 'Error al cargar solicitudes.';
            noRequestsMessageEl.style.display = 'block';
            showNotification(error.message, 'error');
        }
    }

    async function manejarSolicitudInbox(solicitudId, accion) {
        try {
            const res = await fetch(`/api/solicitudes-seguimiento/${solicitudId}/${accion}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const resultado = await res.json();

            if (res.ok) {
                showNotification(resultado.mensaje || `Solicitud ${accion === 'aceptar' ? 'aceptada' : 'rechazada'}.`, 'success');
                const itemToRemove = document.getElementById(`inbox-solicitud-${solicitudId}`);
                if (itemToRemove) {
                    itemToRemove.remove();
                }
                // Check if list is now empty and show message if so
                if (inboxRequestsListEl && noRequestsMessageEl && inboxRequestsListEl.children.length === 1 && inboxRequestsListEl.firstChild.isSameNode(noRequestsMessageEl)) { // Only no-requests message left
                    noRequestsMessageEl.textContent = 'No tienes solicitudes pendientes.'; // Reset message
                    noRequestsMessageEl.style.display = 'block';
                } else if (inboxRequestsListEl && noRequestsMessageEl && inboxRequestsListEl.children.length === 0){ // Should not happen if noRequestsMessageEl is always there but good fallback
                     noRequestsMessageEl.textContent = 'No tienes solicitudes pendientes.';
                     noRequestsMessageEl.style.display = 'block';
                }
            } else {
                throw new Error(resultado.mensaje || `Error al ${accion} la solicitud.`);
            }
        } catch (error) {
            console.error(`Error al ${accion} la solicitud desde inbox:`, error);
            showNotification(error.message, 'error');
        }
    }
  </script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script type="text/javascript" src="notifications.js"></script>
</body>
</html>